---
# VAT Rules for Philippines
# Pattern: PayrollEngine rules DSL with JSONLogic conditions
# Formula evaluation: base * rate

rules:
  # Output VAT (Sales)
  - code: VAT_OUTPUT_STD_12
    name: Standard VAT on sales (12%)
    description: Apply 12% VAT on vatable sales transactions
    priority: 100
    tax_type: vat
    direction: output

    # JSONLogic condition
    condition:
      and:
        - "==": [{"var": "doc_type"}, "invoice"]
        - "==": [{"var": "tax_code"}, "VAT_12_SALES"]
        - ">": [{"var": "gross_amount"}, 0]

    # Formula evaluation
    base_source: gross_amount
    rate_code: VAT_12_SALES
    rate_value: 0.12
    formula: "base * rate"

    # Output bucket
    output_bucket: VAT_OUTPUT_12

    notes: "Standard 12% output VAT on taxable sales"

  - code: VAT_OUTPUT_ZERO
    name: Zero-rated VAT on exports
    description: Apply 0% VAT on export sales (zero-rated)
    priority: 100
    tax_type: vat
    direction: output

    condition:
      and:
        - "==": [{"var": "doc_type"}, "invoice"]
        - "==": [{"var": "tax_code"}, "VAT_ZERO_EXPORTS"]
        - ">": [{"var": "gross_amount"}, 0]

    base_source: gross_amount
    rate_code: VAT_ZERO_EXPORTS
    rate_value: 0.00
    formula: "base * rate"

    output_bucket: VAT_OUTPUT_ZERO

    notes: "Zero-rated VAT for export sales (still considered vatable)"

  - code: VAT_EXEMPT
    name: VAT-exempt sales
    description: No VAT on exempt transactions
    priority: 100
    tax_type: vat
    direction: output

    condition:
      and:
        - "==": [{"var": "doc_type"}, "invoice"]
        - "==": [{"var": "tax_code"}, "VAT_EXEMPT"]
        - ">": [{"var": "gross_amount"}, 0]

    base_source: gross_amount
    rate_value: 0.00
    formula: "base * rate"

    output_bucket: VAT_EXEMPT

    notes: "VAT-exempt transactions (e.g., basic necessities, educational services)"

  # Input VAT (Purchases)
  - code: VAT_INPUT_STD_12
    name: Standard input VAT (12%)
    description: Input VAT on vatable purchases (creditable)
    priority: 100
    tax_type: vat
    direction: input

    condition:
      and:
        - "==": [{"var": "doc_type"}, "bill"]
        - "==": [{"var": "tax_code"}, "VAT_12_PURCHASE"]
        - ">": [{"var": "gross_amount"}, 0]

    base_source: gross_amount
    rate_code: VAT_12_PURCHASE
    rate_value: 0.12
    formula: "base * rate"

    output_bucket: VAT_INPUT_12

    notes: "Input VAT on purchases (creditable against output VAT)"

  - code: VAT_INPUT_ZERO
    name: Zero-rated input VAT
    description: Input VAT on zero-rated purchases
    priority: 100
    tax_type: vat
    direction: input

    condition:
      and:
        - "==": [{"var": "doc_type"}, "bill"]
        - "==": [{"var": "tax_code"}, "VAT_ZERO_PURCHASE"]
        - ">": [{"var": "gross_amount"}, 0]

    base_source: gross_amount
    rate_value: 0.00
    formula: "base * rate"

    output_bucket: VAT_INPUT_ZERO

    notes: "Zero-rated input VAT (creditable)"

  # VAT Payable Calculation
  - code: VAT_PAYABLE
    name: VAT payable calculation
    description: Output VAT minus Input VAT
    priority: 200
    tax_type: vat
    direction: payable

    condition:
      always: true

    formula: "SUM(VAT_OUTPUT_12, VAT_OUTPUT_ZERO) - SUM(VAT_INPUT_12, VAT_INPUT_ZERO)"

    output_bucket: VAT_PAYABLE

    notes: "Net VAT payable (positive) or refundable (negative)"

  # VAT adjustments
  - code: VAT_ADJUSTMENT_PRIOR
    name: Prior period VAT adjustment
    description: Adjustments from prior periods
    priority: 150
    tax_type: vat
    direction: adjustment

    condition:
      "==": [{"var": "adjustment_type"}, "prior_period"]

    base_source: adjustment_amount
    formula: "base"

    output_bucket: VAT_ADJUSTMENT_PRIOR

    notes: "Adjustments carried forward from prior period"

  - code: VAT_ADJUSTMENT_PENALTY
    name: VAT penalty and interest
    description: Penalties and interest on late VAT payments
    priority: 150
    tax_type: vat
    direction: adjustment

    condition:
      "==": [{"var": "adjustment_type"}, "penalty_interest"]

    base_source: adjustment_amount
    formula: "base"

    output_bucket: VAT_PENALTY

    notes: "Penalties for late filing/payment"

metadata:
  version: 1.0.0
  effective_from: "2025-01-01"
  legal_basis:
    - "NIRC Section 106-116"
    - "RR 16-2005 (Amended VAT rules)"
  notes: |
    These rules implement Philippine VAT computation following BIR regulations.
    Formula evaluation uses JSONLogic for conditions and simple arithmetic for calculations.
    Pattern inspired by PayrollEngine's rules DSL and Odoo's tax computation logic.
